{
  "schema_version": "1.0",
  "category": "scroll",
  "steps": [
    {
      "id": "tier_select",
      "name": "Select Treasure Tier",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "tier": ["minor", "medium", "major"] } },
      "weights": { "tier": { "minor": 60, "medium": 30, "major": 10 } },
      "output_bindings": { "tier": "tier" }
    },
    {
      "id": "type_select",
      "name": "Arcane or Divine",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "scroll_type": ["arcane","divine"] } },
      "weights": {
        "scroll_type_by_tier": {
          "minor": { "arcane": 60, "divine": 40 },
          "medium": { "arcane": 55, "divine": 45 },
          "major": { "arcane": 55, "divine": 45 }
        }
      },
      "rules": { "use_tier_weights": true },
      "output_bindings": { "scroll.type": "scroll_type" }
    },
    {
      "id": "spell_count",
      "name": "Number of Spells on the Scroll",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "count": [1,2,3,4,5] } },
      "weights": {
        "count_by_tier": {
          "minor": { "1": 70, "2": 25, "3": 5, "4": 0, "5": 0 },
          "medium": { "1": 55, "2": 30, "3": 12, "4": 3, "5": 0 },
          "major": { "1": 45, "2": 30, "3": 18, "4": 6, "5": 1 }
        }
      },
      "rules": { "use_tier_weights": true },
      "output_bindings": { "scroll.spell_count": "count" }
    },
    {
      "id": "eligible_pool",
      "name": "Build Eligible Spell Pool",
      "kind": "select_base_item",
      "inputs": { "from_table": "sources/PHB/spells/core/spells.master.json" },
      "rules": {
        "arcane_classes": ["sorcerer_wizard","bard"],
        "divine_classes": ["cleric","druid","paladin","ranger"],
        "match_scroll_type_to_classes": true,
        "max_spell_level": 9,
        "allow_level_0": true
      },
      "output_bindings": { "scroll.eligible_spells": "rows" }
    },
    {
      "id": "spell_picker",
      "name": "Pick Spells",
      "kind": "select_base_item",
      "inputs": { "from_prev": "scroll.eligible_spells" },
      "weights": {
        "level_bias_by_tier": {
          "minor": { "0": 15, "1": 55, "2": 25, "3": 5, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0 },
          "medium": { "0": 5, "1": 25, "2": 35, "3": 25, "4": 10, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0 },
          "major": { "0": 0, "1": 10, "2": 20, "3": 25, "4": 20, "5": 15, "6": 7, "7": 3, "8": 0, "9": 0 }
        }
      },
      "rules": {
        "select_n": { "from": "scroll.spell_count" },
        "dedupe_same_spell_id": true,
        "respect_scroll_type_class_lists": true
      },
      "output_bindings": {
        "spells.selected": "result.rows"
      }
    },
    {
      "id": "caster_level",
      "name": "Determine Caster Class and CL per Spell",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "mode": ["minimum","weighted_above_min"] } },
      "weights": { "mode": { "minimum": 80, "weighted_above_min": 20 } },
      "rules": {
        "class_preference_order_arcane": ["sorcerer_wizard","bard"],
        "class_preference_order_divine": ["cleric","druid","paladin","ranger"],
        "min_cl_by_class_level": {
          "sorcerer_wizard": { "0": 1, "1": 1, "2": 3, "3": 5, "4": 7, "5": 9, "6": 11, "7": 13, "8": 15, "9": 17 },
          "cleric":           { "0": 1, "1": 1, "2": 3, "3": 5, "4": 7, "5": 9, "6": 11, "7": 13, "8": 15, "9": 17 },
          "druid":            { "0": 1, "1": 1, "2": 3, "3": 5, "4": 7, "5": 9, "6": 11, "7": 13, "8": 15, "9": 17 },
          "bard":             { "0": 1, "1": 1, "2": 4, "3": 7, "4": 10, "5": 13, "6": 16, "7": 19, "8": 20, "9": 20 },
          "paladin":          { "0": 1, "1": 4, "2": 7, "3": 10, "4": 13, "5": 20, "6": 20, "7": 20, "8": 20, "9": 20 },
          "ranger":           { "0": 1, "1": 4, "2": 7, "3": 10, "4": 13, "5": 20, "6": 20, "7": 20, "8": 20, "9": 20 }
        },
        "weighted_above_min_profile": { "delta_0": 70, "delta_1": 20, "delta_2": 10 },
        "cap_max_cl": 20,
        "zero_level_treated_as_half": true
      },
      "output_bindings": {
        "spells.caster_bindings": "result.class_and_cl_per_spell"
      }
    },
    {
      "id": "scribe_stats",
      "name": "Scribing Details",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "script_style": ["common","draconic","elven","dwarven","celestial","abyssal","infernal"] } },
      "weights": { "script_style": { "common": 35, "draconic": 20, "elven": 15, "dwarven": 10, "celestial": 8, "abyssal": 6, "infernal": 6 } },
      "rules": { "flavor_only": true },
      "output_bindings": { "scribe.script_style": "script_style" }
    },
    {
      "id": "pricing",
      "name": "Price Scroll",
      "kind": "magic_core",
      "rules": {
        "per_spell_formula": "25 * spell_level_effective * caster_level",
        "zero_level_effective_level": 0.5,
        "sum_all_spells": true,
        "rounding": "nearest_integer"
      },
      "output_bindings": {
        "pricing.total_gp": "result.total_gp",
        "pricing.breakdown": "result.breakdown"
      }
    },
    {
      "id": "int_check",
      "name": "Intelligent Item Check",
      "kind": "intelligent_item_check",
      "weights": { "chance_pct_by_tier": { "minor": 0, "medium": 0, "major": 0 } },
      "output_bindings": { "intelligent.is_intelligent": "result.pass" }
    },
    {
      "id": "curse_check",
      "name": "Cursed Item Check",
      "kind": "cursed_item_check",
      "inputs": { "tables": "sources/DMG/items/magic/cursed_item_tables.core.json" },
      "weights": { "curse_roll_pct": 5 },
      "output_bindings": { "cursed.roll": "result.roll", "cursed.is_cursed": "result.pass" }
    },
    {
      "id": "curse_apply",
      "name": "Apply Curse",
      "kind": "cursed_item_apply",
      "rules": { "select_family_by_tier": true },
      "output_bindings": { "cursed.details": "result.curse" }
    },
    {
      "id": "flavor",
      "name": "Item Flavor",
      "kind": "flavor",
      "rules": {
        "ai_flavor_allowed": true,
        "tone": "arcane or divine as chosen",
        "include_script_style": true
      },
      "output_bindings": { "flavor.text": "result.text", "flavor.tags": "result.tags" }
    },
    {
      "id": "desc",
      "name": "Item Description Synthesis",
      "kind": "description_synth",
      "rules": { "include_blocks": ["scroll_type","spells","pricing","curse","history"], "omit_if_absent": true },
      "output_bindings": { "description.text": "result.text" }
    }
  ]
}
