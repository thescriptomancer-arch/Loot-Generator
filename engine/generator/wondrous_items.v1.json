{
  "schema_version": "1.0",
  "category": "wondrous",
  "steps": [
    {
      "id": "tier_select",
      "name": "Select Treasure Tier",
      "kind": "select_base_item",
      "inputs": {
        "inline_choices": { "tier": ["minor", "medium", "major"] }
      },
      "weights": { "tier": { "minor": 60, "medium": 30, "major": 10 } },
      "output_bindings": { "tier": "tier" }
    },
    {
      "id": "slot_select",
      "name": "Select Body Slot",
      "kind": "select_base_item",
      "inputs": {
        "inline_choices": {
          "slot": ["head","face","throat","shoulders","torso","body","arms","hands","ring","waist","feet","slotless"]
        }
      },
      "weights": {
        "slot": {
          "head": 8, "face": 5, "throat": 8, "shoulders": 8, "torso": 6, "body": 4, "arms": 6, "hands": 8,
          "ring": 14, "waist": 8, "feet": 8, "slotless": 7
        }
      },
      "output_bindings": { "wondrous.slot": "slot" }
    },
    {
      "id": "specific_or_procedural",
      "name": "Specific vs Procedural",
      "kind": "select_base_item",
      "inputs": {
        "inline_choices": { "mode": ["procedural","specific_from_index"] }
      },
      "weights": {
        "mode_by_tier": {
          "minor": { "procedural": 85, "specific_from_index": 15 },
          "medium": { "procedural": 80, "specific_from_index": 20 },
          "major": { "procedural": 75, "specific_from_index": 25 }
        }
      },
      "rules": { "use_tier_weights": true },
      "output_bindings": { "wondrous.build_mode": "mode" }
    },
    {
      "id": "specific_pick",
      "name": "Pick Specific Wondrous Item",
      "kind": "select_base_item",
      "inputs": {
        "from_table": "sources/DMG/items/unique/unique_items.index.json"
      },
      "rules": {
        "only_if": { "wondrous.build_mode": "specific_from_index" },
        "filter_by_field_equals": { "category": "wondrous" },
        "skip_if_table_missing": true
      },
      "output_bindings": {
        "specific.id": "row.id",
        "specific.name": "row.name",
        "specific.source_page": "row.source_page"
      }
    },
    {
      "id": "effects_determine",
      "name": "Determine Procedural Effects",
      "kind": "wondrous_effect_build",
      "inputs": {
        "inline_templates": [
          {
            "id": "tmpl_endure_elements_continuous",
            "name": "Endure Elements (continuous)",
            "spell_id": "SPELL_ENDURE_ELEMENTS",
            "spell_level": 1,
            "caster_level": 1,
            "activation": "continuous",
            "duration_category": "twenty_four_hours",
            "charges_per_day": null
          },
          {
            "id": "tmpl_invisibility_3day",
            "name": "Invisibility (3/day, command word)",
            "spell_id": "SPELL_INVISIBILITY",
            "spell_level": 2,
            "caster_level": 3,
            "activation": "command_word",
            "duration_category": "minutes_per_level",
            "charges_per_day": 3
          },
          {
            "id": "tmpl_levitate_1day",
            "name": "Levitate (1/day, command word)",
            "spell_id": "SPELL_LEVITATE",
            "spell_level": 2,
            "caster_level": 3,
            "activation": "command_word",
            "duration_category": "minutes_per_level",
            "charges_per_day": 1
          },
          {
            "id": "tmpl_feather_fall_use",
            "name": "Feather Fall (use-activated)",
            "spell_id": "SPELL_FEATHER_FALL",
            "spell_level": 1,
            "caster_level": 1,
            "activation": "use_activated",
            "duration_category": "instantaneous",
            "charges_per_day": null
          }
        ]
      },
      "weights": {
        "template_by_tier": {
          "minor": { "tmpl_endure_elements_continuous": 25, "tmpl_invisibility_3day": 20, "tmpl_levitate_1day": 18, "tmpl_feather_fall_use": 37 },
          "medium": { "tmpl_endure_elements_continuous": 15, "tmpl_invisibility_3day": 35, "tmpl_levitate_1day": 25, "tmpl_feather_fall_use": 25 },
          "major": { "tmpl_endure_elements_continuous": 10, "tmpl_invisibility_3day": 40, "tmpl_levitate_1day": 30, "tmpl_feather_fall_use": 20 }
        }
      },
      "rules": {
        "only_if": { "wondrous.build_mode": "procedural" },
        "select_count_by_tier": { "minor": 1, "medium": 1, "major": 1 }
      },
      "output_bindings": {
        "procedural.effects": "result.effects",
        "pricing.base_formulae": "result.formulae"
      }
    },
    {
      "id": "multiple_abilities",
      "name": "Multiple Different Abilities",
      "kind": "compound_ability_packaging",
      "inputs": {
        "inline_choices": { "add_count": [0,1,2] }
      },
      "weights": {
        "add_count_by_tier": {
          "minor": { "0": 85, "1": 15, "2": 0 },
          "medium": { "0": 60, "1": 35, "2": 5 },
          "major": { "0": 40, "1": 45, "2": 15 }
        }
      },
      "rules": {
        "only_if": { "wondrous.build_mode": "procedural" },
        "pairing_strategy": "lower_priced_abilities_get_multiplier",
        "multiplier_slot_items": 1.5,
        "multiplier_slotless_items": 2.0
      },
      "output_bindings": {
        "procedural.additional_effects": "result.added",
        "pricing.compound_multiplier_applied": "result.multiplier_applied"
      }
    },
    {
      "id": "space_limitation",
      "name": "Space Limitation",
      "kind": "space_limitation_mod",
      "inputs": {
        "inline_choices": { "mode": ["standard","uncustomary","slotless"] }
      },
      "weights": {
        "mode_by_slot": {
          "slotless": { "standard": 0, "uncustomary": 0, "slotless": 100 },
          "default": { "standard": 95, "uncustomary": 4, "slotless": 1 }
        }
      },
      "rules": {
        "multiplier_for_uncustomary": 1.5,
        "multiplier_for_slotless": 2.0,
        "apply_to_final_magic_price": true
      },
      "output_bindings": {
        "pricing.space_mode": "mode",
        "pricing.space_multiplier": "result.multiplier"
      }
    },
    {
      "id": "int_check",
      "name": "Intelligent Item Check",
      "kind": "intelligent_item_check",
      "weights": { "chance_pct_by_tier": { "minor": 1, "medium": 2, "major": 5 } },
      "output_bindings": {
        "intelligent.roll": "result.roll",
        "intelligent.is_intelligent": "result.pass"
      }
    },
    {
      "id": "int_build",
      "name": "Build Intelligence",
      "kind": "intelligent_item_build",
      "inputs": { "tables": "sources/DMG/items/magic/intelligent_item_tables.core.json" },
      "rules": { "enforce_alignment_constraints": true, "compute_ego": true },
      "output_bindings": { "intelligent.profile": "result.profile", "intelligent.ego": "result.ego" }
    },
    {
      "id": "curse_check",
      "name": "Cursed Item Check",
      "kind": "cursed_item_check",
      "inputs": { "tables": "sources/DMG/items/magic/cursed_item_tables.core.json" },
      "weights": { "curse_roll_pct": 5 },
      "output_bindings": { "cursed.roll": "result.roll", "cursed.is_cursed": "result.pass" }
    },
    {
      "id": "curse_apply",
      "name": "Apply Curse",
      "kind": "cursed_item_apply",
      "rules": { "select_family_by_tier": true },
      "output_bindings": { "cursed.details": "result.curse" }
    },
    {
      "id": "flavor",
      "name": "Item Flavor",
      "kind": "flavor",
      "rules": {
        "ai_flavor_allowed": true,
        "tone": "evocative",
        "respect_alignment": true
      },
      "output_bindings": { "flavor.text": "result.text", "flavor.tags": "result.tags" }
    },
    {
      "id": "desc",
      "name": "Item Description Synthesis",
      "kind": "description_synth",
      "rules": { "include_blocks": ["base","slot","procedural_effects","intelligence","curse","history"], "omit_if_absent": true },
      "output_bindings": { "description.text": "result.text" }
    },
    {
      "id": "pricing",
      "name": "Pricing and Finalization",
      "kind": "magic_core",
      "rules": {
        "formulas": {
          "command_word_factor": 1800,
          "use_activated_factor": 2000,
          "continuous_factor": 2000,
          "charges_per_day_divisor": 5.0,
          "duration_multipliers": {
            "rounds_per_level": 4.0,
            "minutes_per_level": 2.0,
            "ten_minutes_per_level": 1.5,
            "hours_per_level": 1.0,
            "twenty_four_hours": 2.0,
            "instantaneous": 2.0
          }
        },
        "apply_compound_multiplier": true,
        "apply_space_multiplier": true
      },
      "output_bindings": {
        "pricing.total_gp": "result.total_gp",
        "pricing.breakdown": "result.breakdown"
      }
    }
  ]
}
