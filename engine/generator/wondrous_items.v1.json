{
  "schema_version": "1.0",
  "category": "wondrous",
  "steps": [
    {
      "id": "tier_select",
      "name": "Select Treasure Tier",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "tier": ["minor","medium","major"] } },
      "weights": { "tier": { "minor": 60, "medium": 30, "major": 10 } },
      "output_bindings": { "tier": "tier" }
    },
    {
      "id": "slot_select",
      "name": "Select Body Slot",
      "kind": "select_base_item",
      "inputs": {
        "inline_choices": {
          "slot": ["head","face","throat","shoulders","torso","body","arms","hands","ring","waist","feet","slotless"]
        }
      },
      "weights": {
        "slot": {
          "head": 8, "face": 5, "throat": 8, "shoulders": 8, "torso": 6, "body": 4,
          "arms": 6, "hands": 8, "ring": 14, "waist": 8, "feet": 8, "slotless": 7
        }
      },
      "output_bindings": { "wondrous.slot": "slot" }
    },
    {
      "id": "build_mode",
      "name": "Specific vs Procedural",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "mode": ["procedural","specific_from_index"] } },
      "weights": {
        "mode_by_tier": {
          "minor": { "procedural": 85, "specific_from_index": 15 },
          "medium": { "procedural": 80, "specific_from_index": 20 },
          "major": { "procedural": 75, "specific_from_index": 25 }
        }
      },
      "rules": { "use_tier_weights": true },
      "output_bindings": { "wondrous.build_mode": "mode" }
    },
    {
      "id": "specific_pick",
      "name": "Pick Specific Wondrous Item",
      "kind": "select_base_item",
      "inputs": { "from_table": "sources/ALL/items/unique/unique_items.all.index.json" },
      "rules": {
        "only_if": { "wondrous.build_mode": "specific_from_index" },
        "filter_by_field_equals": { "category": "wondrous" },
        "skip_if_table_missing": true
      },
      "output_bindings": {
        "specific.id": "row.id",
        "specific.name": "row.name",
        "specific.source_page": "row.source_page"
      }
    },
    {
      "id": "effects_determine",
      "name": "Determine Procedural Effects",
      "kind": "wondrous_effect_build",
      "inputs": {
        "from_table": "sources/DMG/items/wondrous/wondrous_effects.core.json"
      },
      "weights": {
        "template_by_tier": {
          "minor": {
            "wond_endure_elements_continuous": 20,
            "wond_feather_fall_use": 24,
            "wond_invisibility_3day": 16,
            "wond_levitate_1day": 18,
            "wond_blink_1day": 6,
            "wond_resist_energy_continuous_10": 10,
            "wond_resist_energy_continuous_20": 0,
            "wond_resist_energy_continuous_30": 0,
            "wond_fly_1day": 6,
            "wond_gaseous_form_1day": 4,
            "wond_invisibility_purge_3day": 2,
            "wond_protection_deflection_bonus": 22,
            "wond_natural_armor_amulet": 16,
            "wond_resistance_cloak": 22,
            "wond_dexterity_gloves": 14,
            "wond_strength_belt": 12,
            "wond_intelligence_headband": 12,
            "wond_see_invisibility_1day": 8,
            "wond_true_seeing_1day": 0,
            "wond_water_breathing_1day": 2
          },
          "medium": {
            "wond_endure_elements_continuous": 10,
            "wond_feather_fall_use": 10,
            "wond_invisibility_3day": 20,
            "wond_levitate_1day": 16,
            "wond_blink_1day": 12,
            "wond_resist_energy_continuous_10": 10,
            "wond_resist_energy_continuous_20": 14,
            "wond_resist_energy_continuous_30": 4,
            "wond_fly_1day": 12,
            "wond_gaseous_form_1day": 10,
            "wond_invisibility_purge_3day": 10,
            "wond_protection_deflection_bonus": 24,
            "wond_natural_armor_amulet": 20,
            "wond_resistance_cloak": 24,
            "wond_dexterity_gloves": 20,
            "wond_strength_belt": 20,
            "wond_intelligence_headband": 20,
            "wond_see_invisibility_1day": 12,
            "wond_true_seeing_1day": 4,
            "wond_water_breathing_1day": 8
          },
          "major": {
            "wond_endure_elements_continuous": 5,
            "wond_feather_fall_use": 4,
            "wond_invisibility_3day": 18,
            "wond_levitate_1day": 12,
            "wond_blink_1day": 15,
            "wond_resist_energy_continuous_10": 6,
            "wond_resist_energy_continuous_20": 14,
            "wond_resist_energy_continuous_30": 14,
            "wond_fly_1day": 14,
            "wond_gaseous_form_1day": 10,
            "wond_invisibility_purge_3day": 12,
            "wond_protection_deflection_bonus": 26,
            "wond_natural_armor_amulet": 24,
            "wond_resistance_cloak": 26,
            "wond_dexterity_gloves": 24,
            "wond_strength_belt": 24,
            "wond_intelligence_headband": 24,
            "wond_see_invisibility_1day": 14,
            "wond_true_seeing_1day": 10,
            "wond_water_breathing_1day": 10
          }
        },
        "bonus_rolls_by_tier": {
          "wond_protection_deflection_bonus": {
            "minor": { "1": 65, "2": 25, "3": 10, "4": 0, "5": 0 },
            "medium": { "1": 25, "2": 40, "3": 25, "4": 8, "5": 2 },
            "major": { "1": 0, "2": 20, "3": 35, "4": 30, "5": 15 }
          },
          "wond_natural_armor_amulet": {
            "minor": { "1": 55, "2": 30, "3": 15, "4": 0, "5": 0 },
            "medium": { "1": 15, "2": 35, "3": 35, "4": 12, "5": 3 },
            "major": { "1": 0, "2": 10, "3": 35, "4": 35, "5": 20 }
          },
          "wond_resistance_cloak": {
            "minor": { "1": 70, "2": 25, "3": 5, "4": 0, "5": 0 },
            "medium": { "1": 30, "2": 45, "3": 25, "4": 0, "5": 0 },
            "major": { "1": 0, "2": 20, "3": 35, "4": 30, "5": 15 }
          },
          "wond_dexterity_gloves": {
            "minor": { "2": 85, "4": 15, "6": 0 },
            "medium": { "2": 30, "4": 55, "6": 15 },
            "major": { "2": 0, "4": 45, "6": 55 }
          },
          "wond_strength_belt": {
            "minor": { "2": 85, "4": 15, "6": 0 },
            "medium": { "2": 30, "4": 55, "6": 15 },
            "major": { "2": 0, "4": 45, "6": 55 }
          },
          "wond_intelligence_headband": {
            "minor": { "2": 85, "4": 15, "6": 0 },
            "medium": { "2": 30, "4": 55, "6": 15 },
            "major": { "2": 0, "4": 45, "6": 55 }
          }
        }
      },
      "rules": {
        "only_if": { "wondrous.build_mode": "procedural" },
        "select_count_by_tier": { "minor": 1, "medium": 1, "major": 1 },
        "respect_slot_hints": true,
        "slot_match_weight_multiplier": 2.0,
        "param_energy_type_uniform": true,
        "apply_bonus_rolls_if_formula_kind_is_bonus_squared": true
      },
      "output_bindings": {
        "procedural.effects": "result.effects",
        "pricing.formulae": "result.formulae",
        "procedural.metadata": "result.metadata"
      }
    },
    {
      "id": "multiple_abilities",
      "name": "Multiple Different Abilities",
      "kind": "compound_ability_packaging",
      "inputs": { "inline_choices": { "add_count": [0,1,2] } },
      "weights": {
        "add_count_by_tier": {
          "minor": { "0": 85, "1": 15, "2": 0 },
          "medium": { "0": 60, "1": 35, "2": 5 },
          "major": { "0": 40, "1": 45, "2": 15 }
        }
      },
      "rules": {
        "only_if": { "wondrous.build_mode": "procedural" },
        "pairing_strategy": "lower_priced_abilities_get_multiplier",
        "multiplier_slot_items": 1.5,
        "multiplier_slotless_items": 2.0
      },
      "output_bindings": {
        "procedural.additional_effects": "result.added",
        "pricing.compound_multiplier_applied": "result.multiplier_applied"
      }
    },
    {
      "id": "space_limitation",
      "name": "Space Limitation",
      "kind": "space_limitation_mod",
      "inputs": { "inline_choices": { "mode": ["standard","uncustomary","slotless"] } },
      "weights": {
        "mode_by_slot": {
          "slotless": { "standard": 0, "uncustomary": 0, "slotless": 100 },
          "default": { "standard": 95, "uncustomary": 4, "slotless": 1 }
        }
      },
      "rules": {
        "multiplier_for_uncustomary": 1.5,
        "multiplier_for_slotless": 2.0,
        "apply_to_final_magic_price": true
      },
      "output_bindings": {
        "pricing.space_mode": "mode",
        "pricing.space_multiplier": "result.multiplier"
      }
    },
    {
  "id": "signature_traits",
  "name": "Apply Signature Traits (DMG II)",
  "kind": "select_from_table",
  "inputs": {
    "from_table": "sources/DMG2/items/magic/signature_traits.dmg2.core.json"
  },
  "weights": {
    "chance_pct": { "minor": 10, "medium": 10, "major": 10 }
  },
  "output_bindings": {
    "signature_trait.id": "row.id",
    "signature_trait.name": "row.name"
  }
},

    {
      "id": "int_check",
      "name": "Intelligent Item Check",
      "kind": "intelligent_item_check",
      "weights": { "chance_pct_by_tier": { "minor": 1, "medium": 2, "major": 5 } },
      "output_bindings": { "intelligent.roll": "result.roll", "intelligent.is_intelligent": "result.pass" }
    },
    {
      "id": "int_build",
      "name": "Build Intelligence",
      "kind": "intelligent_item_build",
      "inputs": { "tables": "sources/DMG/items/magic/intelligent_item_tables.core.json" },
      "rules": { "enforce_alignment_constraints": true, "compute_ego": true },
      "output_bindings": { "intelligent.profile": "result.profile", "intelligent.ego": "result.ego" }
    },
    {
      "id": "curse_check",
      "name": "Cursed Item Check",
      "kind": "cursed_item_check",
      "inputs": { "tables": "sources/DMG/items/magic/cursed_item_tables.core.json" },
      "weights": { "curse_roll_pct": 5 },
      "output_bindings": { "cursed.roll": "result.roll", "cursed.is_cursed": "result.pass" }
    },
    {
      "id": "curse_apply",
      "name": "Apply Curse",
      "kind": "cursed_item_apply",
      "rules": { "select_family_by_tier": true },
      "output_bindings": { "cursed.details": "result.curse" }
    },
    {
      "id": "flavor",
      "name": "Item Flavor",
      "kind": "flavor",
      "rules": {
        "ai_flavor_allowed": true,
        "tone": "evocative",
        "respect_slot_and_effects": true
      },
      "output_bindings": { "flavor.text": "result.text", "flavor.tags": "result.tags" }
    },
    {
      "id": "desc",
      "name": "Item Description Synthesis",
      "kind": "description_synth",
      "rules": {
        "include_blocks": ["slot","procedural_effects","space_mode","intelligence","curse","pricing","history"],
        "omit_if_absent": true
      },
      "output_bindings": { "description.text": "result.text" }
    },
    {
      "id": "pricing",
      "name": "Pricing and Finalization",
      "kind": "magic_core",
      "rules": {
        "formulas": {
          "command_word_factor": 1800,
          "use_activated_factor": 2000,
          "continuous_factor": 2000,
          "charges_per_day_divisor": 5.0,
          "duration_multipliers": {
            "rounds_per_level": 4.0,
            "minutes_per_level": 2.0,
            "ten_minutes_per_level": 1.5,
            "hours_per_level": 1.0,
            "twenty_four_hours": 2.0,
            "instantaneous": 2.0
          }
        },
        "apply_compound_multiplier": true,
        "apply_space_multiplier": true,
        "support_bonus_squared": true
      },
      "output_bindings": {
        "pricing.total_gp": "result.total_gp",
        "pricing.breakdown": "result.breakdown"
      }
    }
  ]
}
