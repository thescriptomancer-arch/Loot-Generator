{
  "schema_version": "1.0",
  "category": "staff",
  "steps": [
    {
      "id": "tier_select",
      "name": "Select Treasure Tier",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "tier": ["minor","medium","major"] } },
      "weights": { "tier": { "minor": 35, "medium": 40, "major": 25 } },
      "output_bindings": { "tier": "tier" }
    },
    {
      "id": "build_mode",
      "name": "Specific vs Procedural",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "mode": ["procedural","specific_from_index"] } },
      "weights": {
        "mode_by_tier": {
          "minor": { "procedural": 85, "specific_from_index": 15 },
          "medium": { "procedural": 75, "specific_from_index": 25 },
          "major": { "procedural": 70, "specific_from_index": 30 }
        }
      },
      "rules": { "use_tier_weights": true },
      "output_bindings": { "staff.build_mode": "mode" }
    },
    {
      "id": "specific_pick",
      "name": "Pick Specific Staff",
      "kind": "select_base_item",
      "inputs": { "from_table": "sources/DMG/items/unique/unique_items.index.json" },
      "rules": {
        "only_if": { "staff.build_mode": "specific_from_index" },
        "filter_by_field_equals": { "category": "staff" },
        "skip_if_table_missing": true
      },
      "output_bindings": {
        "specific.id": "row.id",
        "specific.name": "row.name",
        "specific.source_page": "row.source_page"
      }
    },
    {
      "id": "function_count",
      "name": "Number of Spell Functions",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "count": [1,2,3] } },
      "weights": {
        "count_by_tier": {
          "minor": { "1": 70, "2": 28, "3": 2 },
          "medium": { "1": 45, "2": 45, "3": 10 },
          "major": { "1": 30, "2": 50, "3": 20 }
        }
      },
      "rules": {
        "only_if": { "staff.build_mode": "procedural" }
      },
      "output_bindings": { "staff.function_count": "count" }
    },
    {
      "id": "spell_pool",
      "name": "Build Eligible Spell Pool",
      "kind": "select_base_item",
      "inputs": { "from_table": "sources/PHB/spells/core/spells.master.json" },
      "rules": {
        "allow_classes": ["sorcerer_wizard","cleric","druid","bard"],
        "max_spell_level": 9,
        "filter_cast_time_under_rounds": 10,
        "disallow_school_subschools": [],
        "fallback_if_missing_target_field": true
      },
      "output_bindings": { "staff.eligible_spells": "rows" }
    },
    {
      "id": "pick_functions",
      "name": "Pick Spell Functions",
      "kind": "select_base_item",
      "inputs": { "from_prev": "staff.eligible_spells" },
      "weights": {
        "level_bias_by_tier": {
          "minor": { "1": 20, "2": 30, "3": 30, "4": 15, "5": 5, "6": 0, "7": 0, "8": 0, "9": 0 },
          "medium": { "1": 5, "2": 15, "3": 25, "4": 25, "5": 18, "6": 8, "7": 4, "8": 0, "9": 0 },
          "major": { "1": 0, "2": 5, "3": 15, "4": 25, "5": 25, "6": 18, "7": 8, "8": 3, "9": 1 }
        }
      },
      "rules": {
        "only_if": { "staff.build_mode": "procedural" },
        "select_n": { "from": "staff.function_count" },
        "dedupe_same_spell_id": true
      },
      "output_bindings": { "staff.functions.core": "result.rows" }
    },
    {
      "id": "charges_per_use",
      "name": "Assign Charges per Use",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "charges_per_use": [1,2,3] } },
      "weights": { "charges_per_use": { "1": 82, "2": 15, "3": 3 } },
      "rules": {
        "only_if": { "staff.build_mode": "procedural" },
        "apply_independently_per_function": true
      },
      "output_bindings": { "staff.functions.charges_per_use": "result.per_row_values" }
    },
    {
      "id": "caster_level",
      "name": "Determine Caster Level",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "mode": ["minimum_highest","weighted_above_min"] } },
      "weights": { "mode": { "minimum_highest": 80, "weighted_above_min": 20 } },
      "rules": {
        "resolve_min_cl_from_highest_spell": true,
        "weighted_above_min_profile": { "delta_0": 65, "delta_1": 25, "delta_2": 10 },
        "cap_max_cl": 20
      },
      "output_bindings": { "staff.caster_level": "result.cl" }
    },
    {
      "id": "total_charges",
      "name": "Total Charges in Staff",
      "kind": "charges_roll",
      "rules": {
        "distribution": { "type": "triangular", "min": 1, "max": 50, "mode": 50 },
        "rounding": "integer",
        "cap_min": 1,
        "cap_max": 50
      },
      "output_bindings": { "staff.total_charges": "result.charges" }
    },
    {
      "id": "base_item_cost",
      "name": "Base Staff Body",
      "kind": "select_base_item",
      "inputs": { "inline_choices": { "masterwork_quarterstaff_gp": [300] } },
      "weights": { "masterwork_quarterstaff_gp": { "300": 100 } },
      "output_bindings": { "pricing.mw_staff_body_gp": "masterwork_quarterstaff_gp" }
    },
    {
      "id": "pricing",
      "name": "Price Staff",
      "kind": "magic_core",
      "rules": {
        "per_function_formula": "750 * spell_level * caster_level * charges_per_use",
        "sum_all_functions": true,
        "add_masterwork_staff_body": true,
        "masterwork_staff_body_key": "pricing.mw_staff_body_gp",
        "scale_by_remaining_charges": true,
        "charges_current_key": "staff.total_charges",
        "charges_full_value": 50,
        "rounding": "nearest_integer"
      },
      "output_bindings": {
        "pricing.total_gp": "result.total_gp",
        "pricing.breakdown": "result.breakdown"
      }
    },
    {
      "id": "int_check",
      "name": "Intelligent Item Check",
      "kind": "intelligent_item_check",
      "weights": { "chance_pct_by_tier": { "minor": 1, "medium": 2, "major": 4 } },
      "output_bindings": { "intelligent.is_intelligent": "result.pass" }
    },
    {
      "id": "int_build",
      "name": "Build Intelligence",
      "kind": "intelligent_item_build",
      "inputs": { "tables": "sources/DMG/items/magic/intelligent_item_tables.core.json" },
      "rules": { "enforce_alignment_constraints": true, "compute_ego": true },
      "output_bindings": { "intelligent.profile": "result.profile", "intelligent.ego": "result.ego" }
    },
    {
      "id": "curse_check",
      "name": "Cursed Item Check",
      "kind": "cursed_item_check",
      "inputs": { "tables": "sources/DMG/items/magic/cursed_item_tables.core.json" },
      "weights": { "curse_roll_pct": 5 },
      "output_bindings": { "cursed.roll": "result.roll", "cursed.is_cursed": "result.pass" }
    },
    {
      "id": "curse_apply",
      "name": "Apply Curse",
      "kind": "cursed_item_apply",
      "rules": { "select_family_by_tier": true },
      "output_bindings": { "cursed.details": "result.curse" }
    },
    {
      "id": "flavor",
      "name": "Item Flavor",
      "kind": "flavor",
      "rules": {
        "ai_flavor_allowed": true,
        "tone": "arcane_or_divine",
        "respect_spell_theme": true
      },
      "output_bindings": { "flavor.text": "result.text", "flavor.tags": "result.tags" }
    },
    {
      "id": "desc",
      "name": "Item Description Synthesis",
      "kind": "description_synth",
      "rules": {
        "include_blocks": ["base","functions","charges","intelligence","curse","pricing","history"],
        "omit_if_absent": true
      },
      "output_bindings": { "description.text": "result.text" }
    }
  ]
}
